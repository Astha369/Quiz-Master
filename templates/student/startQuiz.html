<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Start The Quiz</title>
    <link rel="icon" href="../../static/images/icon.png" type="image/x-icon">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <link href="../../static/css/style.css" rel="stylesheet">
    <link rel="stylesheet" href="../../static/css/startQuiz.css">
</head>

<body>
    <div class="top-bar">
        <div id="question-counter">Questions:
            <span id="currentQuestion">1</span>/<span id="totalQuestions"></span>
        </div>
        <div id="timer">Time Left: <span id="countdown"></span></div>
    </div>

    <!-- Quiz Box -->
    <div class="container">
        <div class="question">
            <strong id="questionNumber">1:</strong> <span id="questionText">What is the capital of France?</span>
        </div>

        <div class="options" id="optionsContainer">
        </div>

        <div class="buttons">
            <button class="save" onclick="nextQuestion()">Save and Continue</button>
            <button class="submit" onclick="submitQuiz()">Submit</button>
        </div>
    </div>

    <script>
        // Countdown Timer Logic
        let quizDuration = parseInt("{{ quiz.duration }}") * 60;
        let timeLeft = quizDuration;
        let currentQuestionIndex = 0;
        let score = 0;
        let questions = JSON.parse('{{ questions | tojson | safe }}');
        let totalQuestions = questions.length;

        document.getElementById("totalQuestions").innerText = totalQuestions;

        function startTimer() {
            let timerElement = document.getElementById("countdown");

            let timerInterval = setInterval(function () {
                let minutes = Math.floor(timeLeft / 60);
                let seconds = timeLeft % 60;
                seconds = seconds < 10 ? "0" + seconds : seconds;

                timerElement.innerText = `${minutes}:${seconds}`;

                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    alert("Time's up! Submitting the quiz.");
                }

                timeLeft--;
            }, 1000);
        }

        function loadQuestion() {
            if (currentQuestionIndex >= totalQuestions) {
                submitQuiz();
                return;
            }
            let question = questions[currentQuestionIndex];
            document.getElementById("questionNumber").innerText = `${currentQuestionIndex + 1}:`;
            document.getElementById("questionText").innerText = question.questionText;

            let optionsContainer = document.getElementById("optionsContainer")
            optionsContainer.innerHTML = "";

            let options = [question.option1, question.option2, question.option3, question.option4];

            options.forEach((option, index) => {
                let label = document.createElement("label");
                label.innerHTML = `<input type="radio" name="answer" value="${index + 1}"> ${option}`;
                optionsContainer.appendChild(label);
            });

            document.getElementById("currentQuestion").innerText = currentQuestionIndex + 1;
        }

        function nextQuestion() {
            let selectedOption = document.querySelector('input[name="answer"]:checked');

            if (!selectedOption) {
                alert("Please select an answer before continuing!");
                return;
            }

            if (currentQuestionIndex >= questions.length) {
                submitQuiz();
                return;
            }

            let currentQuestion = questions[currentQuestionIndex];

            if (!currentQuestion) {
                console.error("Error: Question is undefined at index:", currentQuestionIndex);
                return;
            }

            let correctAnswer = currentQuestion.correctOption;
            if (selectedOption.value == correctAnswer) {
                score++;
            }

            currentQuestionIndex++;
            loadQuestion();
        }


        function submitQuiz() {
            alert(`Quiz over! your score is ${score}/${totalQuestions}`);
            setTimeout(() => {
                window.location.href = "{{ url_for('student.submitQuiz', quizId=quiz.id, score=0) }}".replace('0', score);
            }, 1000);
        }

        window.onload = function () {
            startTimer();
            loadQuestion();
        };
    </script>

</body>

</html>